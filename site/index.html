<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Team Digests</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css" />
<style>
  .row { display: flex; gap: .75rem; align-items: center; flex-wrap: wrap; }
  .muted { opacity: .7; }
  .chips { display:flex; gap:.5rem; flex-wrap:wrap; }
  .chip { border: 1px solid var(--border); border-radius: 9999px; padding: .25rem .6rem; cursor: pointer; background: transparent; }
  .chip[aria-pressed="true"] { background: var(--button-base); color: var(--button-text); border-color: var(--button-base); }
  .badge { font-size: .75rem; padding:.15rem .45rem; border-radius: 9999px; border:1px solid var(--border); }
  .badge.weekly { background: #e9f5ff4d; }
  .badge.daily { background: #e8ffe94d; }
  .badge.monthly { background: #fff3e6; }
  .list { list-style: none; padding-left: 0; }
  .list li { margin: .35rem 0; }
  .right { float: right; }
  .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: .8em; border:1px solid var(--border); padding:.05rem .35rem; border-radius: .3rem; }
</style>

<main>
  <h1>Team Digests</h1>
  <p class="muted">Search or filter by cadence or owner. Click a result to view the rendered digest; “raw” opens the original Markdown.</p>

  <div class="row" style="align-items:flex-end">
    <div style="flex:1 1 380px; min-width:260px">
      <label for="q">Search filename</label>
      <input id="q" type="search" placeholder="e.g., weekly_2025-10-06" />
    </div>

    <div>
      <label for="cadence">Cadence</label>
      <select id="cadence">
        <option value="">All cadences</option>
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
      </select>
    </div>

    <div>
      <label>Quick</label><br />
      <button class="chip" data-quick="daily"   aria-pressed="false">daily</button>
      <button class="chip" data-quick="weekly"  aria-pressed="false">weekly</button>
      <button class="chip" data-quick="monthly" aria-pressed="false">monthly</button>
      <button class="chip" data-quick="__clear" aria-pressed="false">Clear</button>
    </div>
  </div>

  <!-- Owners row (built from digests.js) -->
  <div class="row" id="owner-row" style="align-items:flex-start">
    <div>
      <label>Owners</label><br />
      <div class="chips" id="owner-chips" aria-label="Filter by owner"></div>
    </div>
  </div>

  <ul id="results" class="list"></ul>

  <p class="muted">
    Tip: press <span class="kbd">/</span> to focus search.
  </p>
</main>

<!-- Digests data created by the workflow -->
<script src="digests.js"></script>
<script>
  const $q = document.getElementById('q');
  const $cadence = document.getElementById('cadence');
  const $results = document.getElementById('results');
  const ownerChips = document.getElementById('owner-chips');

  // quick cadence filter chips
  const quickChips = [...document.querySelectorAll('[data-quick]')];
  const quick = new Set();       // selected cadence chip(s)
  let selectedOwners = new Set(); // selected owner chips

  function matchesQuick(d) {
    if (!quick.size) return true;
    return quick.has(d.cadence);
  }

  function badge(text, cls='') {
    return `<span class="badge ${cls}">${text}</span>`;
  }

  function initQuickChips() {
    quickChips.forEach(btn => {
      btn.addEventListener('click', () => {
        const v = btn.dataset.quick;
        if (v === '__clear') {
          quick.clear();
          quickChips.forEach(b => b.setAttribute('aria-pressed', 'false'));
          render();
          return;
        }
        const pressed = btn.getAttribute('aria-pressed') === 'true';
        btn.setAttribute('aria-pressed', pressed ? 'false' : 'true');
        if (pressed) quick.delete(v); else quick.add(v);
        render();
      });
    });
  }

  function initOwnerChips() {
    const set = new Set();
    (window.digests || []).forEach(d => (d.owners || []).forEach(o => set.add(o)));
    const owners = Array.from(set).sort();

    if (!owners.length) {
      ownerChips.innerHTML = '<span class="muted">No owners found in digests</span>';
      return;
    }

    ownerChips.innerHTML =
      owners.map(o => `<button class="chip" data-owner="${o}" aria-pressed="false">${o}</button>`).join(' ')
      + ' <button class="chip" data-owner="__clear" aria-pressed="false">Clear</button>';

    ownerChips.querySelectorAll('.chip').forEach(btn => {
      btn.addEventListener('click', () => {
        const v = btn.dataset.owner;
        if (v === '__clear') {
          selectedOwners.clear();
          ownerChips.querySelectorAll('.chip').forEach(b => b.setAttribute('aria-pressed','false'));
          render();
          return;
        }
        const pressed = btn.getAttribute('aria-pressed') === 'true';
        btn.setAttribute('aria-pressed', pressed ? 'false' : 'true');
        if (pressed) selectedOwners.delete(v); else selectedOwners.add(v);
        render();
      });
    });
  }

  function render() {
    const term = ($q.value || '').toLowerCase();
    const cad  = $cadence.value;
    const wantOwners = Array.from(selectedOwners);

    const all  = (window.digests || [])
      .filter(d => !cad || d.cadence === cad)
      .filter(d => !term || d.file.toLowerCase().includes(term))
      .filter(d => matchesQuick(d))
      .filter(d => {
        if (!wantOwners.length) return true;
        const have = d.owners || [];
        return wantOwners.every(o => have.includes(o));
      })
      .sort((a,b) => (a.file < b.file ? 1 : -1)); // newest first

    $results.innerHTML = all.map(d => {
      const html = `viewer.html?file=${encodeURIComponent(d.file)}`;
      const cadenceBadge = badge(d.cadence, d.cadence);
      const owners = (d.owners || []).map(o => badge(o)).join(' ');
      return `
        <li>
          <a href="${html}">${d.file}</a>
          <span class="muted">— ${d.date}</span>
          &nbsp; ${cadenceBadge}
          ${owners ? '&nbsp;'+owners : ''}
          <span class="right"><a href="./${encodeURIComponent(d.file)}" class="muted">(raw)</a></span>
        </li>`;
    }).join('') || '<li class="muted">No matches</li>';
  }

  // focus on "/" like GitHub
  window.addEventListener('keydown', (e) => {
    if (e.key === '/' && document.activeElement !== $q) {
      e.preventDefault();
      $q.focus();
    }
  });

  $q.addEventListener('input', render);
  $cadence.addEventListener('change', render);

  initQuickChips();
  render();
  initOwnerChips();
</script>
