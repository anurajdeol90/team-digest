<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Digest Viewer</title>

<!-- Themeable Water.css -->
<link id="theme-light" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/light.min.css" disabled>
<link id="theme-dark"  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/dark.min.css" disabled>

<style>
  .container { max-width: 980px; margin: 0 auto; padding: 1.25rem; display: grid; gap: 1rem; grid-template-columns: 250px 1fr; }
  .sidebar { position: sticky; top: 1rem; align-self: start; max-height: calc(100vh - 2rem); overflow: auto; padding-right: .5rem; }
  .toc { font-size: .95rem; margin: 0; padding-left: 1rem }
  .toc a { display: inline-block; padding: .1rem 0 }
  .toc .lvl-2 { padding-left: .5rem }
  .toc .lvl-3 { padding-left: 1rem }
  .toolbar { grid-column: 1 / -1; display:flex; align-items:center; gap:.6rem; margin-bottom:.2rem }
  .spacer { flex:1 }
  button.theme { font-size:.9rem }
  .anchor-btn { margin-left: .4rem; font-size: .8rem; opacity: .7 }
  .anchor-btn:hover { opacity: 1 }
  .muted { opacity:.75 }

  @media (max-width: 900px) {
    .container { grid-template-columns: 1fr; }
    .sidebar { position: static; max-height: none; }
  }

  /* Print-friendly */
  @media print {
    .toolbar, .sidebar { display: none !important; }
    body { background: #fff !important; color: #000 !important; }
    .container { grid-template-columns: 1fr; padding: 0; margin: 0; }
    a { color: #000 !important; text-decoration: none; }
    pre, code { color: #000 !important; }
  }
</style>

<div class="toolbar">
  <a class="backlink" href="./index.html">‚Üê Back</a>
  <div class="spacer"></div>
  <button class="theme" id="theme-toggle" type="button" title="Toggle light/dark">üåô Dark</button>
  <button type="button" onclick="window.print()" title="Print / Save as PDF">üñ®Ô∏è Print</button>
</div>

<div class="container">
  <aside class="sidebar">
    <h3 style="margin:.2rem 0">Contents</h3>
    <nav id="toc"><p class="muted" style="margin:.4rem 0 0">‚Äî building‚Ä¶</p></nav>
  </aside>
  <main id="app"><p class="muted">Loading‚Ä¶</p></main>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  // THEME TOGGLE ------------------------------------------------------------
  const THEME_KEY = 'team-digest-theme';
  const $light = document.getElementById('theme-light');
  const $dark  = document.getElementById('theme-dark');
  const $btnTheme = document.getElementById('theme-toggle');

  function applyTheme(mode) {
    if (mode === 'light') { $light.disabled = false; $dark.disabled = true;  $btnTheme.textContent='üåû Light'; }
    else if (mode === 'dark') { $light.disabled = true;  $dark.disabled = false; $btnTheme.textContent='üåô Dark'; }
    else { applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'); return; }
    localStorage.setItem(THEME_KEY, mode);
  }
  function initTheme() { applyTheme(localStorage.getItem(THEME_KEY) || null); }
  $btnTheme.addEventListener('click', () => {
    const cur = localStorage.getItem(THEME_KEY) || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    applyTheme(cur === 'dark' ? 'light' : 'dark');
  });
  initTheme();

  // MARKDOWN RENDER + TOC/ANCHORS ------------------------------------------
  const params = new URLSearchParams(location.search);
  const file = params.get('file');
  const app = document.getElementById('app');
  const tocEl = document.getElementById('toc');

  function slugify(text) {
    return text.toLowerCase().trim()
      .replace(/[^\w\s-]/g, '')
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-')
  }

  function addAnchorsAndToc(container) {
    const headings = container.querySelectorAll('h1, h2, h3');
    if (!headings.length) { tocEl.innerHTML = '<p class="muted">‚Äî no headings</p>'; return; }

    const items = [];
    headings.forEach(h => {
      // id
      const text = h.textContent.trim();
      if (!h.id) h.id = slugify(text);

      // copy-link button
      const btn = document.createElement('button');
      btn.className = 'anchor-btn';
      btn.type = 'button';
      btn.title = 'Copy link to this section';
      btn.textContent = 'üîó';
      btn.addEventListener('click', async () => {
        const url = new URL(location.href);
        url.searchParams.set('file', file || '');
        url.hash = h.id;
        try {
          await navigator.clipboard.writeText(url.toString());
          btn.textContent = '‚úÖ';
          setTimeout(() => (btn.textContent = 'üîó'), 1200);
        } catch {
          alert('Copy failed');
        }
      });
      h.appendChild(btn);

      // TOC entry
      const level = Number(h.tagName.substring(1)); // 1,2,3
      items.push({ id: h.id, text, level });
    });

    // build nav
    const ul = document.createElement('ul');
    ul.className = 'toc';
    items.forEach(it => {
      const li = document.createElement('li');
      li.className = 'lvl-' + it.level;
      const a = document.createElement('a');
      a.href = '#' + it.id;
      a.textContent = it.text;
      li.appendChild(a);
      ul.appendChild(li);
    });
    tocEl.innerHTML = '';
    tocEl.appendChild(ul);
  }

  async function load() {
    if (!file) {
      app.innerHTML = '<h1>No file provided</h1><p>Use <code>?file=FILENAME.md</code></p>';
      return;
    }
    try {
      const res = await fetch(file);
      if (!res.ok) throw new Error('Failed to load ' + file);
      const md = await res.text();
      document.title = file + ' ‚Äî Digest';
      app.innerHTML = marked.parse(md);
      // Anchors + TOC
      addAnchorsAndToc(app);
      // If URL has hash, scroll to it (after render)
      if (location.hash) {
        const t = document.getElementById(location.hash.slice(1));
        if (t) t.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    } catch (e) {
      app.innerHTML = '<h1>Error</h1><pre>'+String(e)+'</pre>';
    }
  }
  load();
</script>
