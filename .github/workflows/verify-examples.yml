name: Verify Packaged Examples

on:
  workflow_dispatch:

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install package from PyPI
        run: |
          python -m pip install -U pip
          pip install -U team-digest

      - name: Prepare OUTDIR and copy packaged example logs
        id: prep
        shell: bash
        run: |
          set -euo pipefail
          OUTDIR="$RUNNER_TEMP/td-verify"
          EXLOGS="$RUNNER_TEMP/exlogs"
          mkdir -p "$OUTDIR" "$EXLOGS"

          # Resolve resource to a real filesystem path (no heredocs, one-liner)
          SRC=$(python -c "from importlib.resources import files, as_file; from contextlib import ExitStack; es=ExitStack(); p=es.enter_context(as_file(files('team_digest')/'examples'/'logs')); print(p)")
          echo "Resolved packaged logs path: $SRC"

          # Copy to our real temp folder
          cp -R \"$SRC\"/. \"$EXLOGS\"/

          echo "outdir=$OUTDIR" >> "$GITHUB_OUTPUT"
          echo "exlogs=$EXLOGS" >> "$GITHUB_OUTPUT"

          echo "OUTDIR: $OUTDIR"
          echo "EXLOGS: $EXLOGS"
          echo "Copied logs tree:"
          ls -la "$EXLOGS" || true
          find "$EXLOGS" -type f -maxdepth 2 -print || true

      - name: Show installed version
        shell: bash
        run: |
          python -c "import importlib.metadata as m, team_digest; print('dist:', m.version('team-digest')); print('__version__:', team_digest.__version__)"

      - name: Build weekly/daily/monthly from packaged examples
        shell: bash
        env:
          EXLOGS: ${{ steps.prep.outputs.exlogs }}
          OUTDIR: ${{ steps.prep.outputs.outdir }}
        run: |
          set -euxo pipefail
          echo "EXLOGS=$EXLOGS"
          echo "OUTDIR=$OUTDIR"

          team-digest weekly \
            --logs-dir "$EXLOGS" \
            --start 2025-10-13 --end 2025-10-19 \
            --output "$OUTDIR/weekly.md" \
            --group-actions --emit-kpis --owner-breakdown
          test -s "$OUTDIR/weekly.md"

          team-digest daily \
            --logs-dir "$EXLOGS" \
            --date 2025-10-17 \
            --output "$OUTDIR/daily.md" \
            --group-actions
          test -s "$OUTDIR/daily.md"

          team-digest monthly \
            --logs-dir "$EXLOGS" \
            --output "$OUTDIR/monthly.md" \
            --group-actions --emit-kpis --owner-breakdown
          test -s "$OUTDIR/monthly.md"

          echo "Built files:"
          ls -la "$OUTDIR"

      - name: Upload digests artifact
        uses: actions/upload-artifact@v4
        with:
          name: verify-examples-digests
          path: ${{ steps.prep.outputs.outdir }}/*.md
          if-no-files-found: error
