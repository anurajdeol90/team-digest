name: Verify Packaged Examples

on:
  workflow_dispatch:

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install package from PyPI
        run: |
          python -m pip install -U pip
          pip install -U team-digest

      - name: Prepare OUTDIR and EXLOGS
        id: prep
        shell: bash
        run: |
          set -euo pipefail
          OUTDIR="$RUNNER_TEMP/td-verify"
          mkdir -p "$OUTDIR"

          # Resolve packaged example logs inside the installed wheel (no heredocs)
          EXLOGS=$(python -c "from importlib.resources import files; print(files('team_digest')/'examples'/'logs')")

          echo "outdir=$OUTDIR" >> "$GITHUB_OUTPUT"
          echo "exlogs=$EXLOGS" >> "$GITHUB_OUTPUT"

          echo "OUTDIR: $OUTDIR"
          echo "EXLOGS: $EXLOGS"

      - name: Show installed version
        shell: bash
        run: |
          python -c "import importlib.metadata as m, team_digest; print('dist:', m.version('team-digest')); print('__version__:', team_digest.__version__)"

      - name: Build weekly/daily/monthly from packaged examples
        shell: bash
        env:
          EXLOGS: ${{ steps.prep.outputs.exlogs }}
          OUTDIR: ${{ steps.prep.outputs.outdir }}
        run: |
          set -euo pipefail
          echo "EXLOGS=$EXLOGS"
          echo "OUTDIR=$OUTDIR"

          team-digest weekly \
            --logs-dir "$EXLOGS" \
            --start 2025-10-13 --end 2025-10-19 \
            --output "$OUTDIR/weekly.md" \
            --group-actions --emit-kpis --owner-breakdown

          team-digest daily \
            --logs-dir "$EXLOGS" \
            --date 2025-10-17 \
            --output "$OUTDIR/daily.md" \
            --group-actions

          team-digest monthly \
            --logs-dir "$EXLOGS" \
            --output "$OUTDIR/monthly.md" \
            --group-actions --emit-kpis --owner-breakdown

      - name: Verify outputs exist
        shell: bash
        env:
          OUTDIR: ${{ steps.prep.outputs.outdir }}
        run: |
          set -euo pipefail
          ls -l "$OUTDIR"
          test -f "$OUTDIR/weekly.md"
          test -f "$OUTDIR/daily.md"
          test -f "$OUTDIR/monthly.md"

      - name: Upload digests artifact
        uses: actions/upload-artifact@v4
        with:
          name: verify-examples-digests
          path: ${{ steps.prep.outputs.outdir }}/*.md
          if-no-files-found: error
