name: Verify packaged examples

on:
  workflow_dispatch:

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install team-digest from PyPI (pinned)
        run: |
          python -m pip install -U pip
          pip install -U "team-digest==1.1.14"

      - name: Show installed version (no heredoc)
        run: |
          python -c "import importlib.metadata as m, team_digest; print('dist:', m.version('team-digest')); print('__version__:', team_digest.__version__)"

      - name: Run verification script
        run: |
          python scripts/ci_verify_examples.py

      - name: Collect artifacts
        shell: bash
        run: |
          set -e
          OUT="$RUNNER_TEMP/td-out"
          mkdir -p "$OUT"
          shopt -s nullglob
          for p in /tmp/td-verify-*/*.md; do
            cp "$p" "$OUT"/
          done
          echo "Collected files:" && ls -la "$OUT" || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: verify-examples-digests
          path: ${{ runner.temp }}/td-out/
