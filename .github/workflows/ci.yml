name: CI

on:
  push:
  pull_request:

jobs:
  smoke:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install package (editable) + runtime deps
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Verify CLI wiring
        run: team-digest --help

      - name: Discover log window from repo (if any)
        id: window
        shell: bash
        run: |
          set -euo pipefail
          # Collect YYYY-MM-DD from filenames under logs/
          if ls -1 logs/notes-*.md >/dev/null 2>&1; then
            DATES=$(ls -1 logs/notes-*.md | sed -E 's~.*notes-([0-9]{4}-[0-9]{2}-[0-9]{2})\.md~\1~' | sort)
            START=$(echo "$DATES" | head -n1)
            END=$(echo "$DATES"   | tail -n1)
            echo "start=$START" >> "$GITHUB_OUTPUT"
            echo "end=$END"     >> "$GITHUB_OUTPUT"
            echo "Detected logs window: $START .. $END"
          else
            # No logs present; fall back to today for a no-op digest that still exercises the CLI.
            TODAY=$(date -u +%Y-%m-%d)
            echo "start=$TODAY" >> "$GITHUB_OUTPUT"
            echo "end=$TODAY"   >> "$GITHUB_OUTPUT"
            echo "No logs found; using today $TODAY for smoke test."
          fi

      - name: Build weekly digest (smoke test)
        env:
          START: ${{ steps.window.outputs.start }}
          END:   ${{ steps.window.outputs.end }}
        run: |
          mkdir -p outputs
          team-digest weekly \
            --logs-dir logs \
            --start "$START" \
            --end   "$END" \
            --output outputs/ci_weekly.md \
            --group-actions \
            --emit-kpis \
            --owner-breakdown

          echo "---- Preview (first 40 lines) ----"
          head -n 40 outputs/ci_weekly.md || true

      - name: Upload CI weekly artifact
        uses: actions/upload-artifact@v4
        with:
          name: ci-weekly
          path: outputs/ci_weekly.md
