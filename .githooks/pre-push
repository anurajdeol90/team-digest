#!/usr/bin/env python3
import json, pathlib, re, sys, urllib.request

# Only guard pushes to main
stdin = sys.stdin.read().strip().splitlines()
if not any(line.endswith(" refs/heads/main") for line in stdin):
    sys.exit(0)

# Read version from __init__.py
pp = pathlib.Path("src/team_digest/__init__.py")
m = re.search(r'__version__\s*=\s*[\'"]([^\'"]+)[\'"]', pp.read_text(encoding="utf-8"))
ver = m.group(1) if m else None
if not ver:
    print("[pre-push] Could not read __version__", file=sys.stderr)
    sys.exit(1)

# Check if version already exists on PyPI
try:
    with urllib.request.urlopen("https://pypi.org/pypi/team-digest/json", timeout=10) as r:
        data = json.load(r)
    if ver in (data.get("releases") or {}):
        print(f"[pre-push] Version {ver} already on PyPI. Bump version before pushing.", file=sys.stderr)
        sys.exit(1)
except Exception as e:
    print(f"[pre-push] Warning: PyPI check failed ({e}). Allowing push.", file=sys.stderr)

sys.exit(0)
